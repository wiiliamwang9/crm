<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <title>客户详情</title>
   <!-- 引入 CSS 文件 -->
  <link rel="stylesheet" href="target.css">
  <link rel="stylesheet" href="css/components-common.css">
  <link rel="stylesheet" href="css/todo-area.css">
  <link rel="stylesheet" href="css/tabs.css">
  <link rel="stylesheet" href="css/tag-modal.css">
  <link rel="stylesheet" href="css/follow-up.css">
  <!-- 引入全局API配置 -->
  <script src="../config/api-config.js"></script>
</head>
<body>
  <div class="screen">
    <div class="view">
      <div class="div">
        <svg class="frame back-button" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="goBack()" style="cursor: pointer;">
          <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="text-wrapper">客户详情</div>
        <svg class="img" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="1" stroke="white" stroke-width="2"/>
          <circle cx="19" cy="12" r="1" stroke="white" stroke-width="2"/>
          <circle cx="5" cy="12" r="1" stroke="white" stroke-width="2"/>
        </svg>
      </div>
    </div>
    <div class="view-2">
      <div class="view-3">
        <div class="view-4">
          <img class="image" src="https://c.animaapp.com/mepb4kxjUWP5uf/img/---8.png" />
          <div class="view-5">
            <div class="view-6"><div class="text-wrapper-2">徐小二</div></div>
            <div class="view-7">
              <div class="div-wrapper"><div class="text-wrapper-3">大客户</div></div>
              <div class="frame-2"><div class="text-wrapper-4">新客户</div></div>
              <div class="frame-3"><div class="text-wrapper-5">从未下单</div></div>
            </div>
            <div class="frame-4">
              <div class="frame-5">
                <div class="text-wrapper-6">组织：副食品批发</div>
          
              </div>
              <div class="frame-6">
                <div class="text-wrapper-8">销售：</div>
                <div class="text-wrapper-7">小朋友</div>
              </div>
            </div>
          </div>
        </div>
        <div class="view-8">
          <div class="frame-7">
            <svg class="img-2" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="text-wrapper-9">发微信</div>
          </div>
          <div class="frame-8" onclick="openTodoModal()">
            <svg class="vector" width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#165dff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M2 17L12 22L22 17" stroke="#165dff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M2 12L12 17L22 12" stroke="#165dff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="text-wrapper-10">加待办</div>
          </div>
          <div class="frame-9" onclick="openSOSModal()">
            <svg class="img-2" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="#ff6320" stroke-width="2"/>
              <path d="M9.09 9C9.3251 8.33167 9.78915 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.29152 14.92 10C14.92 12 11.92 13 11.92 13" stroke="#ff6320" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 17H12.01" stroke="#ff6320" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="text-wrapper-11">SOS 求助</div>
          </div>
          <div class="more-actions-container">
            <svg class="frame" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="toggleMoreActions()">
              <circle cx="12" cy="5" r="1" fill="#165dff"/>
              <circle cx="12" cy="12" r="1" fill="#165dff"/>
              <circle cx="12" cy="19" r="1" fill="#165dff"/>
            </svg>
            <!-- 下拉菜单 -->
            <div class="more-actions-dropdown" id="moreActionsDropdown" style="display: none;">
              <div class="dropdown-item" onclick="makePhoneCall()">
                <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M22 16.92V19.92C22.0011 20.1985 21.9441 20.4742 21.8325 20.7293C21.7209 20.9845 21.5573 21.2136 21.3521 21.4019C21.147 21.5901 20.9046 21.7335 20.6407 21.8227C20.3769 21.9119 20.0974 21.9451 19.82 21.92C16.7428 21.5856 13.787 20.5341 11.19 18.85C8.77382 17.3147 6.72533 15.2662 5.18999 12.85C3.49997 10.2412 2.44824 7.27099 2.11999 4.18C2.095 3.90347 2.12787 3.62476 2.21649 3.36162C2.30512 3.09849 2.44756 2.85669 2.63476 2.65162C2.82196 2.44655 3.04981 2.28271 3.30379 2.17052C3.55778 2.05833 3.83233 2.00026 4.10999 2H7.10999C7.59333 1.99522 8.06329 2.16708 8.43248 2.48353C8.80166 2.79999 9.04201 3.23945 9.10999 3.72C9.23662 4.68007 9.47144 5.62273 9.80999 6.53C9.94454 6.88792 9.97366 7.27691 9.8939 7.65088C9.81415 8.02485 9.62886 8.36811 9.35999 8.64L8.08999 9.91C9.51355 12.4135 11.5865 14.4864 14.09 15.91L15.36 14.64C15.6319 14.3711 15.9751 14.1858 16.3491 14.1061C16.7231 14.0263 17.1121 14.0555 17.47 14.19C18.3773 14.5286 19.3199 14.7634 20.28 14.89C20.7658 14.9585 21.2094 15.2032 21.5265 15.5775C21.8437 15.9518 22.0122 16.4296 21.999 16.92H22Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="dropdown-text">打电话</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="view-9">
        <div class="frame-10">
          <div class="text-wrapper-12">最近沟通</div>
          <div class="text-wrapper-13">3 天前</div>
        </div>
        <div class="frame-11">
          <div class="text-wrapper-12">最近下单</div>
          <div class="text-wrapper-13">3 天前</div>
        </div>
        <div class="frame-11">
          <div class="text-wrapper-14">本月营业额</div>
          <div class="text-wrapper-13">1200</div>
        </div>
        <div class="frame-11">
          <div class="text-wrapper-12">总营业额</div>
          <div class="text-wrapper-13">2300</div>
        </div>
      </div>
      <!-- 待办区域组件 -->
      <div id="todo-area-container"></div>
      
      <!-- Tab Container -->
      <div class="tabs-container">
        <!-- Tab Navigation -->
        <div class="view-14">
          <div class="components-tab-2" onclick="switchTab('follow-up')">
            <div class="text-2">跟进记录</div>
          </div>
          <div class="components-tab" onclick="switchTab('tags')">
            <div class="hover-2"></div>
            <div class="text">标签</div>
          </div>
          <div class="components-tab" onclick="switchTab('preferences')">
            <div class="hover-2"></div>
            <div class="text">偏好</div>
          </div>
          <div class="components-tab" onclick="switchTab('contacts')">
            <div class="hover-2"></div>
            <div class="text">熟人</div>
          </div>
          <div class="components-tab" onclick="switchTab('profile')">
            <div class="hover-2"></div>
            <div class="text">资料</div>
          </div>
          <div class="components-tab" onclick="switchTab('notes')">
            <div class="hover-2"></div>
            <div class="text">备注</div>
          </div>
          <div class="components-tab" onclick="switchTab('conversation')">
            <div class="hover-2"></div>
            <div class="text">会话</div>
          </div>
        </div>

        <!-- 跟进记录 Tab Content -->
        <div id="follow-up-tab-container"></div>

        <!-- 标签 Tab Content -->
        <div class="tab-content" id="tags-tab">
          <div class="tags-content">
            <div id="tags-loading" class="loading" style="display: none;">加载中...</div>
            <div id="tags-dimensions-container3"></div>

            <!-- All Tags Section -->
            <div class="all-tags-section">
              <div class="section-title">全部标签</div>
              <div id="all-tags-container"></div>
            </div>

            <div class="edit-tags-btn">
              <button class="primary-btn" onclick="openTagModal()">编辑标签</button>
            </div>

            <script>
            // 动态加载全部标签
            async function loadAllTags() {
              try {
                const response = await fetch(`${getApiBaseUrl()}/api/v1/tag-dimensions`);
                if (response.ok) {
                  const result = await response.json();
                  const dimensions = result.data || [];
                  renderAllTags(dimensions);
                } else {
                  console.error('加载标签维度失败:', response.status);
                  document.getElementById('all-tags-container').innerHTML = '<div class="error-message">加载标签失败</div>';
                }
              } catch (error) {
                console.error('加载标签维度时出错:', error);
                document.getElementById('all-tags-container').innerHTML = '<div class="error-message">网络错误，请检查连接</div>';
              }
            }

            // 渲染全部标签
            function renderAllTags(dimensions) {
              const container = document.getElementById('all-tags-container');
              if (!container) return;
              
              container.innerHTML = '';
              
              dimensions.forEach(dimension => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'tag-category';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'category-title';
                titleDiv.textContent = dimension.name + '：';
                
                const listDiv = document.createElement('div');
                listDiv.className = 'tag-list';
                
                if (dimension.tags && dimension.tags.length > 0) {
                  dimension.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'tag';
                    tagSpan.textContent = tag.name;
                    tagSpan.onclick = function() { toggleTag(this); };
                    listDiv.appendChild(tagSpan);
                  });
                } else {
                  const emptySpan = document.createElement('span');
                  emptySpan.className = 'empty-tags';
                  emptySpan.textContent = '该维度暂无标签';
                  emptySpan.style.color = '#999';
                  emptySpan.style.fontStyle = 'italic';
                  listDiv.appendChild(emptySpan);
                }
                
                categoryDiv.appendChild(titleDiv);
                categoryDiv.appendChild(listDiv);
                container.appendChild(categoryDiv);
              });
            }

            // 页面加载时自动加载标签
            document.addEventListener('DOMContentLoaded', function() {
              loadAllTags();
            });
            </script>
          </div>
        </div>

        <!-- 偏好 Tab Content -->
        <div id="preferences-tab-container"></div>

        <!-- 熟人 Tab Content -->
        <div id="contacts-tab-container"></div>

        <!-- 资料 Tab Content -->
        <div id="profile-tab-container"></div>

        <!-- 备注 Tab Content -->
        <div id="notes-tab-container"></div>

        <!-- 会话 Tab Content -->
        <div id="conversation-tab-container"></div>
      </div>
    </div>
    <div class="view-15">
      <div class="frame-22">
        <img class="img-3" src="../statics/home.svg" width="22" height="22" />
        <div class="text-wrapper-23">首页</div>
      </div>
      <div class="frame-22">
        <img class="img-3" src="../statics/personal-collection.svg" width="22" height="22" />
        <div class="text-wrapper-24">客户</div>
      </div>
      <div class="frame-22">
         <img class="img-3" src="../statics/optional.svg" width="22" height="22" />
        <div class="text-wrapper-23">业绩</div>
      </div>
      <div class="frame-22">
        <img class="img-3" src="../statics/config.svg" width="22" height="22" />
        <div class="text-wrapper-23">设置</div>
      </div>
    </div>
  </div>

  <!-- 加待办弹窗 -->
  <div id="todoModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">新增待办</h3>
        <button class="modal-close" onclick="closeTodoModal()">×</button>
      </div>
      <div class="modal-content">
        <div class="form-row">
          <label class="form-label">计划时间</label>
          <div class="datetime-picker" id="todoDatetimePicker">
            <div class="picker-container">
              <div class="picker-column">
                <div class="picker-header">年</div>
                <div class="picker-scroll" id="yearPicker">
                  <!-- 年份选项将通过JavaScript生成 -->
                </div>
              </div>
              <div class="picker-column">
                <div class="picker-header">月</div>
                <div class="picker-scroll" id="monthPicker">
                  <!-- 月份选项将通过JavaScript生成 -->
                </div>
              </div>
              <div class="picker-column">
                <div class="picker-header">日</div>
                <div class="picker-scroll" id="dayPicker">
                  <!-- 日期选项将通过JavaScript生成 -->
                </div>
              </div>
              <div class="picker-column">
                <div class="picker-header">时</div>
                <div class="picker-scroll" id="hourPicker">
                  <!-- 小时选项将通过JavaScript生成 -->
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">待办类型</label>
          <select class="form-select" id="todoType">
            <option value="call">电话沟通</option>
            <option value="visit">拜访</option>
            <option value="follow-up">跟进</option>
            <option value="meeting">会议</option>
            <option value="other">其他</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">待办内容</label>
          <textarea class="form-textarea" id="todoContent" placeholder="请输入待办内容..."></textarea>
        </div>
        <div class="form-row">
          <label class="form-label">提醒</label>
          <div class="switch-container">
            <input type="checkbox" id="reminderSwitch" class="switch-input">
            <label for="reminderSwitch" class="switch-label">
              <span class="switch-slider"></span>
            </label>
            <span class="switch-text">是否提醒</span>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">执行人</label>
          <div class="searchable-select" id="executorPersonContainer">
            <input type="text" class="searchable-select-input" id="executorPersonInput" placeholder="请选择执行人" readonly>
            <div class="searchable-select-arrow">▼</div>
            <div class="searchable-select-dropdown" id="executorPersonDropdown">
              <div class="searchable-select-search">
                <input type="text" class="searchable-select-search-input" id="executorPersonSearch" placeholder="搜索执行人...">
              </div>
              <div class="searchable-select-options" id="executorPersonOptions">
                <!-- 选项将通过JavaScript动态加载 -->
              </div>
            </div>
            <input type="hidden" id="executorPerson" name="executorPerson">
          </div>
        </div>
        <div class="form-row" id="reminderMethodRow" style="display: none;">
          <label class="form-label">提醒方式</label>
          <select class="form-select" id="reminderMethod">
            <option value="sms">短信</option>
            <option value="wechat">微信</option>
            <option value="enterprise_wechat">企业微信</option>
            <option value="both">微信+企业微信</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeTodoModal()">取消</button>
        <button class="btn-primary" onclick="createTodo()">创建待办</button>
      </div>
    </div>
  </div>

  <!-- 添加记录弹窗 -->
  <div id="recordModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">添加跟进记录</h3>
        <button class="modal-close" onclick="closeRecordModal()">×</button>
      </div>
      <div class="modal-content">
        <div class="form-row">
          <label class="form-label">记录类型</label>
          <select class="form-select" id="recordType">
            <option value="call">电话沟通</option>
            <option value="visit">实地拜访</option>
            <option value="meeting">会议洽谈</option>
            <option value="order">下单记录</option>
            <option value="sample">发样记录</option>
            <option value="feedback">客户反馈</option>
            <option value="complaint">客户投诉</option>
            <option value="payment">付款记录</option>
            <option value="other">其他</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">记录内容</label>
          <textarea class="form-textarea" id="recordContent" placeholder="请详细描述本次跟进的具体情况..."></textarea>
        </div>
        <div class="form-row">
          <label class="form-label">创建待办</label>
          <div class="switch-container">
            <input type="checkbox" id="createTodoSwitch" class="switch-input">
            <label for="createTodoSwitch" class="switch-label">
              <span class="switch-slider"></span>
            </label>
            <span class="switch-text">是否同时创建待办事项</span>
          </div>
        </div>
        <div class="form-row" id="planTimeRow" style="display: none;">
          <label class="form-label">计划时间</label>
          <select class="form-select" id="planTime">
            <option value="today">今日</option>
            <option value="tomorrow">明日</option>
            <option value="this-week">本周内</option>
            <option value="next-week">下周</option>
            <option value="this-month">本月内</option>
            <option value="custom">自定义时间</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeRecordModal()">取消</button>
        <button class="btn-primary" onclick="createRecord()">创建记录</button>
      </div>
    </div>
  </div>

  <!-- 编辑偏好弹窗 -->
  <div id="preferenceModal" class="modal-overlay" style="display: none;">
    <div class="preference-modal-container">
      <div class="preference-header">
        <h3 class="preference-title">徐小二的偏好</h3>
        <button class="modal-close" onclick="closePreferenceModal()">×</button>
      </div>
      <div class="preference-content">
        <!-- 搜索框 -->
        <div class="preference-search-row">
          <input type="text" class="preference-search-input" id="preferenceSearch" placeholder="输入偏好信息后回车添加..." />
        </div>
        
        <!-- 已添加的偏好标签 -->
        <div class="preference-tags-row">
          <div class="preference-tags-container" id="preferenceTagsContainer">
            <span class="preference-tag preference-tag-blue">偏绿</span>
            <span class="preference-tag preference-tag-green">清淡</span>
            <span class="preference-tag preference-tag-yellow">不香</span>
          </div>
        </div>
        
        <!-- 搜索输入框（隐藏，用于创建新产品） -->
        <div class="new-product-input-row" id="newProductInputRow" style="display: none;">
          <input type="text" class="form-input" id="newProductInput" placeholder="请输入新产品名称..." />
        </div>
        
        <!-- 创建新产品按钮 -->
        <div class="create-product-row">
          <button class="create-product-btn" id="createProductBtn" onclick="showNewProductInput()">
            创建新产品 "毛尖"
          </button>
        </div>
        
        <!-- 全部产品标题 -->
        <div class="all-products-title">
          <h4>全部产品</h4>
        </div>
        
        <!-- 产品列表 -->
        <div class="products-list">
          <div class="product-item">
            <div class="product-name">毛尖:</div>
            <div class="product-preferences">
              <span class="product-preference">偏绿</span>
              <span class="product-preference">偏淡</span>
            </div>
          </div>
          <div class="product-item">
            <div class="product-name">菊花:</div>
            <div class="product-preferences">
              <span class="product-preference">香</span>
              <span class="product-preference">不香</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tag Edit Modal -->
  <div class="modal-overlay" id="tag-modal-overlay" style="display: none;">
    <div class="modal-content tag-modal">
      <div class="modal-header">
        <h2 class="modal-title">"徐小二"的标签</h2>
        <button class="modal-close" onclick="closeTagModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6L18 18" stroke="#86909C" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      
      <div class="modal-body tag-modal-body">
        <!-- 搜索框 -->
        <div class="tag-search-box">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="11" cy="11" r="8" stroke="#86909C" stroke-width="2"/>
            <path d="m21 21-4.35-4.35" stroke="#86909C" stroke-width="2"/>
          </svg>
          <input type="text" id="tag-search-input" placeholder="好吃懒做" oninput="onTagSearchInput()" />
          <button class="clear-search" onclick="clearTagSearch()" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M18 6L6 18M6 6L18 18" stroke="#86909C" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        
        <!-- 添加标签按钮 -->
        <div class="add-tag-section">
          <button class="add-tag-btn" onclick="addNewTag()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M12 5v14M5 12h14" stroke="#165DFF" stroke-width="2" stroke-linecap="round"/>
            </svg>
            添加标签
          </button>
        </div>
        
        <!-- 创建新标签提示 -->
        <!-- <div class="create-tag-hint">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" stroke="#165DFF" stroke-width="2"/>
            <path d="M7 7h.01" stroke="#165DFF" stroke-width="2"/>
          </svg>
          创建新标签"好吃懒做"
        </div> -->
        
        <!-- 全部标签 -->
        <div class="all-tags-section">
          <h3>全部标签</h3>
          <div id="modal-all-tags-container">
            <div class="tag-category">
              <span class="category-label">基本：</span>
              <div class="tag-list">
                <span class="tag-item selected">汉族</span>
                <span class="tag-item">少数民族</span>
                <span class="tag-item">回族</span>
              </div>
            </div>
            <div class="tag-category">
              <span class="category-label">社会：</span>
              <div class="tag-list">
                <span class="tag-item">已婚</span>
                <span class="tag-item">高收入</span>
                <span class="tag-item">博士</span>
                <span class="tag-item">茶行业</span>
                <span class="tag-item">销售</span>
                <span class="tag-item">老板</span>
                <span class="tag-item">有子女</span>
              </div>
            </div>
            <div class="tag-category">
              <span class="category-label">个性：</span>
              <div class="tag-list">
                <span class="tag-item">爱足疗</span>
                <span class="tag-item">不喝酒</span>
                <span class="tag-item">不抽烟</span>
                <span class="tag-item">四川辣</span>
                <span class="tag-item">豪爽</span>
              </div>
            </div>
            <div class="tag-category">
              <span class="category-label">行为：</span>
              <div class="tag-list">
                <span class="tag-item">多次下单</span>
                <span class="tag-item">新客户</span>
                <span class="tag-item">从未下单</span>
              </div>
            </div>
            <div class="tag-category">
              <span class="category-label">预测：</span>
              <div class="tag-list">
                <span class="tag-item">疑似流失</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Contact Modal -->
  <div class="modal-overlay" id="addContactModal" style="display: none;">
    <div class="modal-content add-contact-modal">
      <div class="modal-header">
        <div class="modal-title">为"徐小二"添加熟人</div>
        <button class="modal-close" onclick="closeAddContactModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6L18 18" stroke="#86909C" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      
      <div class="modal-body add-contact-body">
        <!-- Contact Row -->
        <div class="contact-row">
          <div class="contact-label">熟人</div>
          <div class="contact-info">
            <img class="contact-avatar" src="https://c.animaapp.com/mepb6uwdEj1aih/img/---12.png" alt="徐小二">
            <span class="contact-name">徐小二</span>
          </div>
          <svg class="chevron-right" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M6 12L10 8L6 4" stroke="#86909C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>

        <!-- Relationship Row -->
        <div class="contact-row">
          <div class="contact-label">关系</div>
          <div class="contact-value">好友</div>
          <svg class="chevron-right" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M6 12L10 8L6 4" stroke="#86909C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>

        <!-- Notes Row -->
        <div class="contact-row notes-row">
          <div class="contact-label">备注</div>
          <div class="contact-notes">
            <input type="text" placeholder="比如怎么认识人的方式..." class="notes-input" id="contactNotes">
          </div>
        </div>

        <!-- Create Button -->
        <div class="create-button-container">
          <button class="create-button" onclick="createContact()">创建记录</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 编辑待办弹窗 -->
  <div id="editTodoModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">编辑待办</h3>
        <button class="modal-close" onclick="closeEditTodoModal()">×</button>
      </div>
      <div class="modal-content">
        <div class="form-row">
          <label class="form-label">计划时间</label>
          <div class="datetime-picker" id="editTodoDatetimePicker">
            <!-- 时间选择器结构将通过JavaScript生成 -->
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">待办类型</label>
          <select class="form-select" id="editTodoType">
            <option value="call">电话沟通</option>
            <option value="visit">拜访</option>
            <option value="follow-up">跟进</option>
            <option value="meeting">会议</option>
            <option value="other">其他</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">待办内容</label>
          <textarea class="form-textarea" id="editTodoContent" placeholder="请输入待办内容..."></textarea>
        </div>
        <div class="form-row">
          <label class="form-label">提醒</label>
          <div class="switch-container">
            <input type="checkbox" id="editReminderSwitch" class="switch-input">
            <label for="editReminderSwitch" class="switch-label">
              <span class="switch-slider"></span>
            </label>
            <span class="switch-text">是否提醒</span>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">执行人</label>
          <div class="searchable-select" id="editExecutorPersonContainer">
            <input type="text" class="searchable-select-input" id="editExecutorPersonInput" placeholder="请选择执行人" readonly>
            <div class="searchable-select-arrow">▼</div>
            <div class="searchable-select-dropdown" id="editExecutorPersonDropdown">
              <div class="searchable-select-search">
                <input type="text" class="searchable-select-search-input" id="editExecutorPersonSearch" placeholder="搜索执行人...">
              </div>
              <div class="searchable-select-options" id="editExecutorPersonOptions">
                <!-- 选项将通过JavaScript动态加载 -->
              </div>
            </div>
            <input type="hidden" id="editExecutorPerson" name="editExecutorPerson">
          </div>
        </div>
        <div class="form-row" id="editReminderMethodRow" style="display: none;">
          <label class="form-label">提醒方式</label>
          <select class="form-select" id="editReminderMethod">
            <option value="sms">短信</option>
            <option value="wechat">微信</option>
            <option value="enterprise_wechat">企业微信</option>
            <option value="both">微信+企业微信</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeEditTodoModal()">取消</button>
        <button class="btn-danger" onclick="deleteCurrentTodo()" style="background-color: #ff4757; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 0 10px;">删除</button>
        <button class="btn-primary" onclick="saveTodo()">保存待办</button>
      </div>
    </div>
  </div>

  <!-- 改时间弹窗 -->
  <div id="changeTimeModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">修改待办时间</h3>
        <button class="modal-close" onclick="closeChangeTimeModal()">×</button>
      </div>
      <div class="modal-content">
        <!-- 当前时间显示 -->
        <div class="form-row">
          <label class="form-label">当前时间：</label>
          <div id="currentTimeDisplay" class="current-time-display">--</div>
        </div>
        
        <!-- 新时间选择器 -->
        <div class="form-row">
          <label class="form-label">计划时间</label>
          <div class="datetime-picker" id="changeTimeDatetimePicker">
            <!-- 时间选择器结构将通过JavaScript生成 -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeChangeTimeModal()">取消</button>
        <button class="btn-primary" onclick="saveNewTime()">确认修改</button>
      </div>
    </div>
  </div>

 <!-- 内联工具函数和组件脚本 -->
 <script>
   // 工具函数
   function getApiBaseUrl() {
     return window.GlobalApiConfig ? window.GlobalApiConfig.BASE_URL : 'http://localhost:8081';
   }

   function getCurrentCustomerId() {
     console.log('=== 获取客户ID调试信息 ===');
     console.log('当前URL:', window.location.href);
     console.log('URL参数字符串:', window.location.search);
     
     const urlParams = new URLSearchParams(window.location.search);
     const customerId = urlParams.get('customer_id');
     
     console.log('从URL获取的customer_id:', customerId);
     console.log('customer_id类型:', typeof customerId);
     
     if (customerId) {
       const parsedId = parseInt(customerId);
       console.log('解析后的客户ID:', parsedId);
       console.log('========================');
       return parsedId;
     }
     
     console.warn('未找到customer_id参数，使用默认客户ID: 92');
     console.log('========================');
     return 92;
   }

   function waitForGlobalConfig() {
     return new Promise((resolve) => {
       if (window.GlobalApiConfig) {
         resolve();
       } else {
         setTimeout(() => waitForGlobalConfig().then(resolve), 100);
       }
     });
   }

   window.usersList = [];

   function getExecutorName(executorId) {
     if (!executorId) return '未知';
     
     const user = window.usersList.find(u => u.id === parseInt(executorId));
     if (user) {
       return user.name;
     }
     
     const executors = {
       1: '小朋友',
       2: '张三', 
       3: '李四',
       4: '王五'
     };
     return executors[executorId] || '未知';
   }

   function getReminderMethodName(reminderType) {
     const methods = {
       'sms': '短信',
       'wechat': '企业微信',
       'email': '邮件'
     };
     return methods[reminderType] || '未设置';
   }

   function formatTodoTime(timeStr) {
     if (!timeStr) return '-';
     
     try {
       const date = new Date(timeStr);
       const now = new Date();
       const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
       const todoDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
       
       const diffDays = Math.floor((todoDate - today) / (1000 * 60 * 60 * 24));
       const timeFormat = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
       
       if (diffDays === 0) {
         return `今天 ${timeFormat}`;
       } else if (diffDays === 1) {
         return `明天 ${timeFormat}`;
       } else if (diffDays === -1) {
         return `昨天 ${timeFormat}`;
       } else if (diffDays > 1 && diffDays <= 7) {
         return `${diffDays}天后 ${timeFormat}`;
       } else if (diffDays < -1 && diffDays >= -7) {
         return `${Math.abs(diffDays)}天前 ${timeFormat}`;
       } else {
         return date.toLocaleDateString('zh-CN') + ' ' + timeFormat;
       }
     } catch (error) {
       console.error('时间格式化错误:', error);
       return timeStr;
     }
   }

   function goBack() {
     if (document.referrer && document.referrer !== window.location.href) {
       window.history.back();
     } else {
       window.location.href = '../query/query_target.html';
     }
   }


   async function loadTodoList() {
     try {
       const response = await fetch(`${getApiBaseUrl()}/api/v1/todos?customer_id=${getCurrentCustomerId()}`);
       if (response.ok) {
         const result = await response.json();
         const todos = result.data || [];
         console.log('Todos loaded:', todos);
         
         window.allTodos = todos;
         // 默认显示今日待办
         filterTodosByStatus('today');
       }
     } catch (error) {
       console.error('Error loading todos:', error);
     }
   }

   function updateTodoListDisplay(todos) {
     const todoContainer = document.getElementById('todo-list-container');
     if (!todoContainer) return;
     
     if (!window.allTodos && todos) {
       window.allTodos = todos;
     }
     
     todoContainer.innerHTML = '';
     
     if (!todos || todos.length === 0) {
       todoContainer.innerHTML = '<div class="no-todos">暂无待办事项</div>';
       return;
     }
     
     todos.forEach(todo => {
       const todoElement = createTodoElement(todo);
       todoContainer.appendChild(todoElement);
     });
   }

   function createTodoElement(todo) {
     const todoDiv = document.createElement('div');
     todoDiv.className = todo.status === 'completed' ? 'frame-17' : 'frame-16';
     todoDiv.setAttribute('data-status', todo.status || 'pending');
     
     const timeDisplay = formatTodoTime(todo.planned_time);
     const executorName = getExecutorName(todo.executor_id);
     const creatorName = getExecutorName(todo.creator_id);
     const reminderDisplay = todo.is_reminder ? 
       getReminderMethodName(todo.reminder_type) : '-';
     
     todoDiv.innerHTML = `
       <div style="width: 100%;">
         <p class="p"><span class="span">待办时间：</span> <span class="text-wrapper-18">${timeDisplay}</span></p>
         <p class="div-2">
           <span class="span">待办内容：</span> <span class="text-wrapper-18">${todo.content}</span>
         </p>
         <div class="frame-6">
           <div class="text-wrapper-8">创建待办：</div>
           <img class="image-2" src="https://c.animaapp.com/mepb4kxjUWP5uf/img/---8.png" />
           <div class="text-wrapper-7">${creatorName}</div>
         </div>
         <div class="frame-6">
           <div class="text-wrapper-8">&nbsp;&nbsp; 执行人：</div>
           <img class="image-2" src="https://c.animaapp.com/mepb4kxjUWP5uf/img/---8.png" />
           <div class="text-wrapper-7">${executorName}</div>
         </div>
         <div class="text-wrapper-19">提醒方式：${reminderDisplay}</div>
         <div style="width: 100%; display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
           ${todo.status !== 'completed' ? `<div class="view-12" onclick="completeTodo(${todo.id})"><div class="text-wrapper-10">完成</div></div>` : ''}
           ${todo.status !== 'completed' ? `<div class="view-12" onclick="openChangeTimeModal(${todo.id})"><div class="text-wrapper-10">改时间</div></div>` : ''}
           ${todo.status !== 'completed' ? `<div class="view-12" onclick="openEditTodoModal(${todo.id})"><div class="text-wrapper-10">编辑</div></div>` : ''}
         </div>
       </div>
     `;
     return todoDiv;
   }

   // 弹窗相关函数由各自模块提供（tabs.js、tags.js等），不在此定义占位符以避免覆盖真实实现。

   // 为弹窗加载标签维度数据
   async function loadModalTagDimensions() {
     const container = document.getElementById('modal-all-tags-container');
     if (!container) return;

     try {
       const response = await fetch(`${getApiBaseUrl()}/api/v1/tag-dimensions`);
       if (!response.ok) {
         throw new Error(`HTTP error! status: ${response.status}`);
       }
       const data = await response.json();
       renderModalTagDimensions(data.data || []);
     } catch (error) {
       console.error('加载标签维度失败:', error);
       container.innerHTML = '<div class="error-message">加载标签失败，请重试</div>';
     }
   }

   // 渲染弹窗中的标签维度
   function renderModalTagDimensions(dimensions) {
     const container = document.getElementById('modal-all-tags-container');
     if (!container) return;

     if (!dimensions || dimensions.length === 0) {
       container.innerHTML = '<div class="no-data">暂无标签数据</div>';
       return;
     }

     let html = '';
     dimensions.forEach(dimension => {
       html += `
         <div class="tag-category">
           <div class="category-title">${dimension.name}：</div>
           <div class="tag-list">`;
       
       if (dimension.tags && dimension.tags.length > 0) {
         dimension.tags.forEach(tag => {
           html += `<span class="tag" onclick="toggleTag(this)" title="${tag.description || ''}">${tag.name}</span>`;
         });
       }
       
       html += `
           </div>
         </div>`;
     });

     container.innerHTML = html;
   }
 </script>
 <!-- 引入主脚本 -->
 <script src="js/searchable-select.js"></script>
 <script src="js/utils.js"></script>
 <script src="js/tabs.js"></script>
 <script src="js/tags.js"></script>
 <script src="js/notes.js"></script>
 <script src="js/profile.js"></script>
 <script src="js/activities.js"></script>
 <script src="js/todo-area.js"></script>
 <script src="target.js"></script>
 
 <!-- 组件内容直接嵌入 -->
 <script>
   document.addEventListener('DOMContentLoaded', function() {
     // 测试openTagModal函数是否可用
     console.log('Testing openTagModal availability:', typeof window.openTagModal);
     if (typeof window.openTagModal === 'undefined') {
       console.error('openTagModal function is not available!');
     }
     
     // 直接设置组件HTML内容
     const componentContents = {
       'todo-area-container': `
         <!-- 待办区域组件 -->
         <div class="view-10">
           <div class="frame-12">
             <div class="frame-13">
               <svg class="bell" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                 <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#1d2129" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                 <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#1d2129" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
               </svg>
               <div class="text-wrapper-15">待办</div>
             </div>
             <div class="view-11">
               <div class="frame-14 todo-tab active" data-status="today" onclick="switchTodoTab('today')"><div class="text-wrapper-16">今日</div></div>
               <div class="frame-15 todo-tab" data-status="all" onclick="switchTodoTab('all')"><div class="text-wrapper-17">全部</div></div>
               <div class="frame-15 todo-tab" data-status="completed" onclick="switchTodoTab('completed')"><div class="text-wrapper-17">已完成</div></div>
               <div class="frame-15 todo-tab" data-status="pending" onclick="switchTodoTab('pending')"><div class="text-wrapper-17">未完成</div></div>
               <div class="frame-15 todo-tab" data-status="overdue" onclick="switchTodoTab('overdue')"><div class="text-wrapper-17">延期</div></div>
             </div>
           </div>
           <!-- 待办列表容器，通过JavaScript动态加载 -->
           <div id="todo-list-container"></div>
         </div>
       `,
       'follow-up-tab-container': `
         <!-- 跟进记录 Tab Content -->
         <div class="tab-content active" id="follow-up-tab">
           <div class="follow-up-content">
             <!-- 记录类型过滤器 -->
             <div class="follow-up-filter">
               <label for="activity-kind-filter">记录类型：</label>
               <select id="activity-kind-filter" onchange="filterActivitiesByKind()">
                 <option value="all">全部</option>
                 <option value="call">电话沟通</option>
                 <option value="visit">实地拜访</option>
                 <option value="email">邮件</option>
                 <option value="wechat">微信沟通</option>
                 <option value="meeting">会议洽谈</option>
                 <option value="order">下单记录</option>
                 <option value="sample">发样记录</option>
                 <option value="feedback">客户反馈</option>
                 <option value="complaint">客户投诉</option>
                 <option value="payment">付款记录</option>
                 <option value="other">其他</option>
               </select>
             </div>
             <!-- 跟进记录列表容器，通过JavaScript动态加载 -->
             <div id="follow-up-list-container">
               <div class="loading-message">正在加载跟进记录...</div>
             </div>

             <div class="load-more" id="load-more-btn" style="display: none;" onclick="loadMoreActivities()">
<span>查看更多</span>
             </div>

             <div class="add-record-btn">
               <button class="primary-btn" onclick="openRecordModal()">添加记录</button>
             </div>
           </div>
         </div>
       `,

       'preferences-tab-container': `
         <!-- 偏好 Tab Content -->
         <div class="tab-content" id="preferences-tab">
           <div class="preferences-content">
             <div class="preferences-list">
               <div class="preference-item">
                 <div class="preference-product">毛尖:</div>
                 <div class="preference-attributes">
                   <span class="preference-attr">偏绿</span>
                 </div>
               </div>
               
               <div class="preference-item">
                 <div class="preference-product">菊花:</div>
                 <div class="preference-attributes">
                   <span class="preference-attr">不香</span>
                 </div>
               </div>
               
               <div class="preference-item">
                 <div class="preference-product">铁观音:</div>
                 <div class="preference-attributes">
                   <span class="preference-attr">清淡</span>
                   <span class="preference-attr">回甘</span>
                 </div>
               </div>
               
               <div class="preference-item">
                 <div class="preference-product">普洱:</div>
                 <div class="preference-attributes">
                   <span class="preference-attr">醇厚</span>
                   <span class="preference-attr">陈香</span>
                 </div>
               </div>
             </div>
             
             <div class="edit-preferences-btn">
               <button class="primary-btn" onclick="openPreferenceModal()">编辑偏好</button>
             </div>
           </div>
         </div>
       `,
       'contacts-tab-container': `
         <!-- 熟人 Tab Content -->
         <div class="tab-content" id="contacts-tab">
           <div class="contacts-content">
             <div class="contact-section">
               <div class="contact-section-title">同事(1)</div>
               <div class="contact-item">
                 <img class="contact-avatar" src="https://c.animaapp.com/mepb4kxjUWP5uf/img/---8.png" />
                 <div class="contact-info">
                   <div class="contact-name">徐小二</div>
                   <div class="contact-company">副食品批发</div>
                   <div class="contact-tags">
                     <span class="contact-tag blue">大客户</span>
                     <span class="contact-tag green">新客户</span>
                     <span class="contact-tag orange">从未下单</span>
                   </div>
                 </div>
                 <div class="contact-time">3 天前添加</div>
               </div>
             </div>
         
             <div class="contact-section">
               <div class="contact-section-title">好友(1)</div>
               <div class="contact-item">
                 <img class="contact-avatar" src="https://c.animaapp.com/mepb4kxjUWP5uf/img/---8.png" />
                 <div class="contact-info">
                   <div class="contact-name">徐小二</div>
                   <div class="contact-company">副食品批发</div>
                   <div class="contact-tags">
                     <span class="contact-tag blue">大客户</span>
                     <span class="contact-tag green">新客户</span>
                     <span class="contact-tag orange">从未下单</span>
                   </div>
                 </div>
                 <div class="contact-time">3 天前添加</div>
               </div>
             </div>
         
             <div class="add-contact-btn">
               <div class="div-wrapper-2" onclick="openAddContactModal()"><div class="text-wrapper-10">添加熟人</div></div>
             </div>
           </div>
         </div>
       `,
       'profile-tab-container': `
         <!-- 资料 Tab Content -->
         <div class="tab-content" id="profile-tab">
           <div class="frame-wrapper">
             <div class="frame-18">
               <img class="image-3" src="https://c.animaapp.com/mepb4kxjUWP5uf/img/---8.png" />
               <img class="image-4" src="https://c.animaapp.com/mepb4kxjUWP5uf/img/---8.png" />
               <img class="image-5" src="https://c.animaapp.com/mepb4kxjUWP5uf/img/---8.png" />
             </div>
           </div>
           <div class="frame-19">
             <div class="frame-20">
               <div class="text-wrapper-20">别名</div>
               <div class="text-wrapper-21" id="customerContactName">-</div>
             </div>
             <div class="frame-20">
               <div class="text-wrapper-20">电话</div>
               <div class="text-wrapper-21" id="customerPhones">-</div>
             </div>
             <div class="frame-20">
               <div class="text-wrapper-20">微信</div>
               <div class="text-wrapper-21" id="customerWechats">-</div>
             </div>
           </div>
         </div>
       `,
       'notes-tab-container': `
         <!-- 备注 Tab Content -->
         <div class="tab-content" id="notes-tab">
           <div class="notes-container">
             <textarea class="notes-textarea" id="customerNotes" placeholder="请输入客户备注信息..." maxlength="1000"></textarea>
             <div class="notes-footer">
               <div class="character-count">
                 <span id="notesCharCount">0</span>/1000
               </div>
               <div class="save-status" id="saveStatus">已保存</div>
             </div>
           </div>
         </div>
       `,
       'conversation-tab-container': `
         <!-- 会话 Tab Content -->
         <div class="tab-content" id="conversation-tab">
           <div class="frame-21">
             <svg class="dollar-sign" width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
               <circle cx="12" cy="12" r="10" stroke="#86909c" stroke-width="2"/>
               <path d="M16 8C16 10.21 14.21 12 12 12C9.79 12 8 10.21 8 8C8 5.79 9.79 4 12 4C14.21 4 16 5.79 16 8Z" stroke="#86909c" stroke-width="2"/>
               <path d="M12 14C8.13 14 5 16.57 5 19.5V20H19V19.5C19 16.57 15.87 14 12 14Z" stroke="#86909c" stroke-width="2"/>
             </svg>
             <div class="text-wrapper-22">所属销售未开启会话存档</div>
           </div>
         </div>
       `
     };
     
     // 设置组件内容
     for (const [containerId, content] of Object.entries(componentContents)) {
       const container = document.getElementById(containerId);
       if (container) {
         container.innerHTML = content;
       }
     }
     
     console.log('Components loaded successfully');
     
     // 初始化页面
     setTimeout(() => {
       switchTab('follow-up'); // 默认显示跟进记录tab
       switchTodoTab('today');
       
       // 模拟一些待办数据（用于测试显示）
       const mockTodos = [
         {
           id: 1,
           content: '电话回访客户需求',
           planned_time: new Date().toISOString(),
           status: 'pending',
           creator_id: 1,
           executor_id: 1,
           is_reminder: true,
           reminder_type: 'wechat'
         },
         {
           id: 2,
           content: '准备产品演示材料',
           planned_time: new Date(Date.now() + 24*60*60*1000).toISOString(),
           status: 'pending',
           creator_id: 1,
           executor_id: 2,
           is_reminder: false,
           reminder_type: null
         }
       ];
       
       window.allTodos = mockTodos;
       updateTodoListDisplay(mockTodos);
       
     }, 100);
   });
 </script>

</body>
</html>
