<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢</title>
    <link rel="stylesheet" href="style.css">
    <!-- å¼•å…¥å…¨å±€APIé…ç½® -->
    <script src="../config/api-config.js"></script>
    <style>
        /* æ–‡å­—å¤´åƒæ ·å¼ */
        .text-avatar {
            position: relative;
            width: 44px;
            height: 44px;
            background-color: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50%;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        
        .result-item .avatar {
            position: relative;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .result-item .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* æ ‡ç­¾åŠ è½½é”™è¯¯æç¤ºæ ·å¼ */
        .error-message {
            text-align: center;
            padding: 20px;
            color: #ff4757;
            font-size: 14px;
            background-color: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨æœç´¢åŒºåŸŸ -->
        <header class="header">
            <div class="header-content">
                <button class="back-btn">â€¹</button>
                <button class="close-btn">Ã—</button>
                <h1 class="title">æœç´¢</h1>
                <button class="menu-btn">â‹¯</button>
            </div>
            
            <div class="search-section">
                <div class="search-input-wrapper">
                    <input type="text" class="search-input" placeholder="æœç´¢å®¢æˆ·ã€ç»„ç»‡ç­‰">
                    <button class="cancel-btn">å–æ¶ˆ</button>
                </div>
                <!-- ç¯å¢ƒçŠ¶æ€æ˜¾ç¤º -->
                <div id="env-status" style="font-size: 12px; color: #666; text-align: center; margin-top: 5px; display: none;">
                    ç¯å¢ƒï¼š<span id="current-env">--</span> | APIï¼š<span id="api-url">--</span>
                    <button onclick="testApiConnection()" style="margin-left: 10px; font-size: 10px; padding: 2px 6px;">æµ‹è¯•è¿æ¥</button>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- æœç´¢å†å² -->
            <section class="search-history">
                <div class="section-header">
                    <h2>æœç´¢å†å²</h2>
                    <button class="clear-history">ğŸ—‘</button>
                </div>
                <div class="history-tags">
                </div>
            </section>

            <!-- æ ‡ç­¾ç­›é€‰ -->
            <section class="filter-section">
                <h3>æ ‡ç­¾</h3>
                <div id="tags-loading" class="loading" style="display: none;">
                    <div>ğŸ”„ åŠ è½½æ ‡ç­¾ä¸­...</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">é¦–æ¬¡åŠ è½½å¯èƒ½è¾ƒæ…¢ï¼Œè¯·ç¨å€™</div>
                </div>
                <div id="tags-dimensions-container">
                    <!-- æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </section>

            <!-- æœç´¢ç»“æœ -->
            <section class="search-results hidden">
                <div class="results-header">
                    <h3>å®¢æˆ· (0)</h3>
                </div>
                <div class="result-list">
                    <!-- æœç´¢ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>
        </main>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="view-15">
            <div class="frame-22">
                <img src="../statics/home.svg" class="img-3" width="22" height="22" />
                <div class="text-wrapper-23">é¦–é¡µ</div>
            </div>
            <div class="frame-22">
                <img class="img-3" src="../statics/personal-collection.svg" width="22" height="22" />
                <div class="text-wrapper-24">å®¢æˆ·</div>
            </div>
            <div class="frame-22">
                <img class="img-3" src="../statics/optional.svg" width="22" height="22" />
                <div class="text-wrapper-23">ä¸šç»©</div>
            </div>
            <div class="frame-22">
                <img class="img-3" src="../statics/config.svg" width="22" height="22" />
                <div class="text-wrapper-23">è®¾ç½®</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentSearchTerm = '';
        let isSearching = false;
        let searchCache = new Map(); // æœç´¢ç»“æœç¼“å­˜
        let searchTimeout = null; // é˜²æŠ–å®šæ—¶å™¨
        let searchHistoryData = []; // æœç´¢å†å²è®°å½•
        let tagDimensionsData = []; // æ ‡ç­¾ç»´åº¦æ•°æ®
        let selectedTags = new Set(); // å·²é€‰æ‹©çš„æ ‡ç­¾
        
        // ==================== ç¯å¢ƒé…ç½® ====================
        // APIé…ç½®ç°åœ¨ä»å…¨å±€é…ç½®æ–‡ä»¶ ../config/api-config.js ä¸­åŠ è½½
        
        // ç­‰å¾…å…¨å±€é…ç½®åŠ è½½å®Œæˆ
        function waitForGlobalConfig() {
            return new Promise((resolve) => {
                if (window.GlobalApiConfig) {
                    resolve();
                } else {
                    setTimeout(() => waitForGlobalConfig().then(resolve), 100);
                }
            });
        }
        
        // é…ç½®å¸¸é‡ï¼ˆä¿ç•™éAPIç›¸å…³çš„é…ç½®ï¼‰
        const CONFIG = {
            REQUEST_TIMEOUT: 30000, // 30ç§’è¶…æ—¶
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000, // 1ç§’é‡è¯•å»¶è¿Ÿ
            DEBOUNCE_DELAY: 500, // 500msé˜²æŠ–å»¶è¿Ÿ
            CACHE_EXPIRE_TIME: 5 * 60 * 1000, // 5åˆ†é’Ÿç¼“å­˜è¿‡æœŸ
            MAX_SEARCH_HISTORY: 10, // æœ€å¤§æœç´¢å†å²æ•°é‡
            SEARCH_HISTORY_KEY: 'crm_search_history' // æœ¬åœ°å­˜å‚¨é”®å
        };

        // DOMå…ƒç´ 
        const searchInput = document.querySelector('.search-input');
        const cancelBtn = document.querySelector('.cancel-btn');
        const searchHistory = document.querySelector('.search-history');
        const filterSection = document.querySelector('.filter-section');
        const searchResults = document.querySelector('.search-results');
        const resultList = document.querySelector('.result-list');

        // è·å–APIåŸºç¡€URL (ä½¿ç”¨å…¨å±€é…ç½®)
        function getApiBaseUrl() {
            return window.GlobalApiConfig ? window.GlobalApiConfig.BASE_URL : '';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // ç­‰å¾…å…¨å±€é…ç½®åŠ è½½å®Œæˆ
            await waitForGlobalConfig();
            
            initializeEventListeners();
            updateEnvDisplay();
            
            // åŠ è½½æœç´¢å†å²
            loadSearchHistory();
            renderSearchHistory();
            
            // åŠ è½½æ ‡ç­¾æ•°æ®
            await loadTagDimensions();
            
            console.log('=== ç¯å¢ƒé…ç½®ä¿¡æ¯ ===');
            console.log('å½“å‰ç¯å¢ƒ:', window.GlobalApiConfig.ENV_NAME);
            console.log('APIåŸºç¡€URL:', window.GlobalApiConfig.BASE_URL);
            console.log('å½“å‰è®¿é—®åè®®:', window.location.protocol);
            console.log('==================');
        });
        
        // æ›´æ–°ç¯å¢ƒæ˜¾ç¤º
        function updateEnvDisplay() {
            const envStatus = document.getElementById('env-status');
            const currentEnvSpan = document.getElementById('current-env');
            const apiUrlSpan = document.getElementById('api-url');
            
            if (envStatus && currentEnvSpan && apiUrlSpan) {
                currentEnvSpan.textContent = window.GlobalApiConfig.ENV_NAME;
                apiUrlSpan.textContent = window.GlobalApiConfig.BASE_URL;
                // åœ¨å¼€å‘æ—¶æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒå¯ä»¥éšè—
                if (window.GlobalApiConfig.ENV_NAME === 'LOCAL') {
                    envStatus.style.display = 'block';
                }
            }
        }

        function initializeEventListeners() {
            // æœç´¢è¾“å…¥äº‹ä»¶ - ä½¿ç”¨ä¼˜åŒ–åçš„é˜²æŠ–
            searchInput.addEventListener('input', debounce(handleSearch, CONFIG.DEBOUNCE_DELAY));
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });

            // å–æ¶ˆæŒ‰é’®
            cancelBtn.addEventListener('click', clearSearch);

            // æ¸…ç©ºæœç´¢å†å²æŒ‰é’®
            const clearHistoryBtn = document.querySelector('.clear-history');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearSearchHistory);
            }

            // è¿”å›æŒ‰é’®
            document.querySelector('.back-btn').addEventListener('click', function() {
                window.history.back();
            });

            // å…³é—­æŒ‰é’®
            document.querySelector('.close-btn').addEventListener('click', function() {
                window.close();
            });
        }

        // é˜²æŠ–å‡½æ•° - ä¼˜åŒ–ç‰ˆ
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    searchTimeout = null;
                    func.apply(this, args);
                };
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                searchTimeout = setTimeout(later, wait);
            };
        }
        
        // ç¼“å­˜ç®¡ç†
        function getCachedResult(key) {
            const cached = searchCache.get(key);
            if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_EXPIRE_TIME) {
                return cached.data;
            }
            return null;
        }
        
        function setCachedResult(key, data) {
            searchCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
            // é™åˆ¶ç¼“å­˜å¤§å°
            if (searchCache.size > 50) {
                const firstKey = searchCache.keys().next().value;
                searchCache.delete(firstKey);
            }
        }
        
        // è¶…æ—¶æ§åˆ¶çš„fetch
        async function fetchWithTimeout(url, options, timeout = CONFIG.REQUEST_TIMEOUT) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        // ==================== æœç´¢å†å²ç®¡ç† ====================
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœç´¢å†å²
        function loadSearchHistory() {
            try {
                const saved = localStorage.getItem(CONFIG.SEARCH_HISTORY_KEY);
                searchHistoryData = saved ? JSON.parse(saved) : [];
            } catch (error) {
                console.error('åŠ è½½æœç´¢å†å²å¤±è´¥:', error);
                searchHistoryData = [];
            }
        }

        // ä¿å­˜æœç´¢å†å²åˆ°æœ¬åœ°å­˜å‚¨
        function saveSearchHistory() {
            try {
                localStorage.setItem(CONFIG.SEARCH_HISTORY_KEY, JSON.stringify(searchHistoryData));
            } catch (error) {
                console.error('ä¿å­˜æœç´¢å†å²å¤±è´¥:', error);
            }
        }

        // æ·»åŠ æœç´¢å…³é”®è¯åˆ°å†å²è®°å½•
        function addToSearchHistory(keyword) {
            if (!keyword || keyword.trim() === '') return;
            
            keyword = keyword.trim();
            
            // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤æ—§çš„
            const index = searchHistoryData.indexOf(keyword);
            if (index > -1) {
                searchHistoryData.splice(index, 1);
            }
            
            // æ·»åŠ åˆ°æœ€å‰é¢
            searchHistoryData.unshift(keyword);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (searchHistoryData.length > CONFIG.MAX_SEARCH_HISTORY) {
                searchHistoryData = searchHistoryData.slice(0, CONFIG.MAX_SEARCH_HISTORY);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveSearchHistory();
            
            // æ›´æ–°ç•Œé¢
            renderSearchHistory();
        }

        // æ¸²æŸ“æœç´¢å†å²ç•Œé¢
        function renderSearchHistory() {
            const historyTagsContainer = document.querySelector('.history-tags');
            if (!historyTagsContainer) return;
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            historyTagsContainer.innerHTML = '';
            
            // æ·»åŠ æœç´¢å†å²æ ‡ç­¾
            searchHistoryData.forEach(keyword => {
                const tag = document.createElement('span');
                tag.className = 'history-tag';
                tag.textContent = keyword;
                tag.addEventListener('click', () => {
                    searchInput.value = keyword;
                    handleSearch();
                });
                historyTagsContainer.appendChild(tag);
            });
        }

        // æ¸…ç©ºæœç´¢å†å²
        function clearSearchHistory() {
            searchHistoryData = [];
            saveSearchHistory();
            renderSearchHistory();
        }
        
        // é‡è¯•æœºåˆ¶
        async function retryRequest(requestFn, maxRetries = CONFIG.MAX_RETRIES) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await requestFn();
                } catch (error) {
                    lastError = error;
                    console.warn(`è¯·æ±‚å¤±è´¥ï¼Œç¬¬${attempt}æ¬¡å°è¯•:`, error.message);
                    
                    if (attempt < maxRetries) {
                        const delay = CONFIG.RETRY_DELAY * attempt; // é€’å¢å»¶è¿Ÿ
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw lastError;
        }

        // å¤„ç†æœç´¢
        async function handleSearch() {
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm === '') {
                showInitialView();
                return;
            }

            if (searchTerm === currentSearchTerm && isSearching) {
                return; // é¿å…é‡å¤æœç´¢
            }

            currentSearchTerm = searchTerm;
            isSearching = true;

            try {
                console.log('å¼€å§‹æœç´¢:', searchTerm);
                showLoadingState();
                const customers = await searchCustomers(searchTerm);
                console.log('æœç´¢ç»“æœ:', customers);
                displaySearchResults(customers);
                
                // æœç´¢æˆåŠŸåæ·»åŠ åˆ°æœç´¢å†å²
                addToSearchHistory(searchTerm);
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
                showErrorMessage(`æœç´¢å¤±è´¥: ${error.message || 'è¯·ç¨åé‡è¯•'}`);
            } finally {
                isSearching = false;
            }
        }

        // è°ƒç”¨åç«¯APIæœç´¢å®¢æˆ· - ä½¿ç”¨POSTè¯·æ±‚ã€ç¼“å­˜ã€é‡è¯•å’Œè¶…æ—¶
        async function searchCustomers(searchTerm) {
            // æ£€æŸ¥ç¼“å­˜
            const cacheKey = searchTerm.toLowerCase().trim();
            const cached = getCachedResult(cacheKey);
            if (cached) {
                console.log('ä½¿ç”¨ç¼“å­˜ç»“æœ:', searchTerm);
                return cached;
            }
            
            // æ„å»ºè¯·æ±‚
            const apiUrl = window.GlobalApiConfig.getUrl(window.GlobalApiConfig.ENDPOINTS.CUSTOMERS.SEARCH);
            
            console.log('=== API è¯·æ±‚ä¿¡æ¯ ===');
            console.log('API URL:', apiUrl);
            console.log('æœç´¢å…³é”®è¯:', searchTerm);
            console.log('==================');
            
            const requestBody = {
                search: searchTerm || ' ', // ç¡®ä¿æœç´¢è¯ä¸ä¸ºç©º
                limit: 50,
                page: 1,
                timestamp: Date.now()
            };
            
            console.log('è¯·æ±‚ä½“:', JSON.stringify(requestBody, null, 2));
            
            // ä½¿ç”¨é‡è¯•æœºåˆ¶è¿›è¡Œè¯·æ±‚
            const customers = await retryRequest(async () => {
                console.log('å‘é€POSTè¯·æ±‚åˆ°:', apiUrl);
                console.log('è¯·æ±‚æ–¹æ³•: POST');
                console.log('è¯·æ±‚å¤´:', {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                });
                
                const response = await fetchWithTimeout(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
                console.log('å“åº”å¤´:', Object.fromEntries(response.headers));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    let errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${response.status})`;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        } else if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (parseError) {
                        console.log('æ— æ³•è§£æé”™è¯¯å“åº”ä¸ºJSON:', parseError);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('APIå“åº”æ•°æ®:', data);
                return data.data?.customers || data.customers || [];
            });
            
            // ç¼“å­˜ç»“æœ
            setCachedResult(cacheKey, customers);
            console.log('æœç´¢å®Œæˆï¼Œç»“æœå·²ç¼“å­˜:', searchTerm, customers.length, 'æ¡è®°å½•');
            
            return customers;
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(customers) {
            hideInitialView();
            showSearchResults();

            // æ›´æ–°ç»“æœæ•°é‡
            const resultsHeader = document.querySelector('.results-header h3');
            resultsHeader.textContent = `å®¢æˆ· (${customers.length})`;

            // æ¸…ç©ºç°æœ‰ç»“æœ
            resultList.innerHTML = '';

            if (customers.length === 0) {
                resultList.innerHTML = `
                    <div class="no-results">
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">æœªæ‰¾åˆ°ç›¸å…³å®¢æˆ·</div>
                            <div style="font-size: 14px;">è¯·å°è¯•å…¶ä»–å…³é”®è¯</div>
                        </div>
                    </div>
                `;
                return;
            }

            // æ¸²æŸ“å®¢æˆ·åˆ—è¡¨
            customers.forEach(customer => {
                const resultItem = createCustomerResultItem(customer);
                resultList.appendChild(resultItem);
            });
        }

        // åˆ›å»ºå®¢æˆ·ç»“æœé¡¹
        function createCustomerResultItem(customer) {
            console.log('åˆ›å»ºå®¢æˆ·ç»“æœé¡¹:', customer.name, 'ID:', customer.id);
            const div = document.createElement('div');
            div.className = 'result-item';
            div.setAttribute('data-customer-id', customer.id);

            // å¤„ç†æ ‡ç­¾
            const tags = createCustomerTags(customer);
            
            // å¤„ç†è”ç³»ä¿¡æ¯
            const contactInfo = getCustomerContactInfo(customer);

            // å¤„ç†å¤´åƒ
            const avatarHtml = createCustomerAvatarDisplay(customer);

            div.innerHTML = `
                ${avatarHtml}
                <div class="user-info">
                    <div class="user-name">${escapeHtml(customer.name || 'æœªçŸ¥å®¢æˆ·')}</div>
                    <div class="user-detail">${escapeHtml(contactInfo)}</div>
                    <div class="user-tags">${tags}</div>
                </div>
            `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            div.addEventListener('click', () => {
                handleCustomerClick(customer);
            });

            return div;
        }

        // åˆ›å»ºå®¢æˆ·å¤´åƒ
        function createCustomerAvatarDisplay(customer) {
            console.log('åˆ›å»ºå®¢æˆ·å¤´åƒ:', customer.name, 'å¤´åƒURL:', customer.avatar);
            if (customer.avatar && customer.avatar.trim()) {
                // æœ‰å¤´åƒå›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                console.log('ä½¿ç”¨å›¾ç‰‡å¤´åƒ');
                return `<div class="avatar"><img src="${escapeHtml(customer.avatar)}" alt="å¤´åƒ" /></div>`;
            } else if (customer.name) {
                // æ²¡æœ‰å¤´åƒå›¾ç‰‡ï¼Œæ˜¾ç¤ºæ–‡å­—å¤´åƒ
                const firstChar = customer.name.charAt(0);
                console.log('ä½¿ç”¨æ–‡å­—å¤´åƒ:', firstChar);
                return `<div class="avatar"><div class="text-avatar">${escapeHtml(firstChar)}</div></div>`;
            } else {
                // æ²¡æœ‰åç§°ï¼Œä½¿ç”¨é»˜è®¤
                console.log('ä½¿ç”¨é»˜è®¤å¤´åƒ');
                return `<div class="avatar"><div class="text-avatar">?</div></div>`;
            }
        }

        // åˆ›å»ºå®¢æˆ·æ ‡ç­¾
        function createCustomerTags(customer) {
            const tags = [];

            // å®¢æˆ·ç­‰çº§æ ‡ç­¾
            if (customer.level) {
                const levelText = getLevelText(customer.level);
                if (levelText) {
                    tags.push(`<span class="tag-blue">${levelText}</span>`);
                }
            }

            // å®¢æˆ·çŠ¶æ€æ ‡ç­¾
            if (customer.state) {
                const stateText = getStateText(customer.state);
                if (stateText) {
                    tags.push(`<span class="tag-green">${stateText}</span>`);
                }
            }

            // è‡ªå®šä¹‰æ ‡ç­¾
            if (customer.tags && customer.tags.length > 0) {
                customer.tags.slice(0, 3).forEach(tag => {
                    tags.push(`<span class="tag-orange">${escapeHtml(tag)}</span>`);
                });
            }

            return tags.join('');
        }

        // è·å–å®¢æˆ·è”ç³»ä¿¡æ¯
        function getCustomerContactInfo(customer) {
            const info = [];
            
            if (customer.contact_name) {
                info.push(customer.contact_name);
            }
            
            if (customer.phone) {
                info.push(customer.phone);
            }
            
            if (customer.address) {
                info.push(customer.address);
            }

            return info.join(' â€¢ ') || 'æ— è”ç³»ä¿¡æ¯';
        }

        // è·å–ç­‰çº§æ–‡å­—
        function getLevelText(level) {
            const levelMap = {
                1: 'Sçº§',
                2: 'Açº§', 
                3: 'Bçº§',
                4: 'Cçº§',
                10: 'Xçº§'
            };
            return levelMap[level] || '';
        }

        // è·å–çŠ¶æ€æ–‡å­—
        function getStateText(state) {
            const stateMap = {
                1: 'æœªå¼€å‘',
                2: 'å¼€å‘ä¸­',
                3: 'å·²å¼€å‘',
                4: 'å·²æ‹‰é»‘',
                5: 'å·²å€’é—­',
                6: 'åŒäº‹',
                7: 'å›å¾’',
                8: 'åŒè¡Œ'
            };
            return stateMap[state] || '';
        }

        // å¤„ç†å®¢æˆ·ç‚¹å‡»
        function handleCustomerClick(customer) {
            console.log('=== å®¢æˆ·ç‚¹å‡»è°ƒè¯•ä¿¡æ¯ ===');
            console.log('å®Œæ•´å®¢æˆ·å¯¹è±¡:', customer);
            console.log('å®¢æˆ·ID:', customer.id);
            console.log('å®¢æˆ·IDç±»å‹:', typeof customer.id);
            console.log('å®¢æˆ·åç§°:', customer.name);
            console.log('========================');
            
            // è·³è½¬åˆ°å®¢æˆ·è¯¦æƒ…é¡µé¢ï¼Œä¼ é€’å®¢æˆ·IDä½œä¸ºå‚æ•°
            if (customer.id) {
                const targetUrl = `../target/target.html?customer_id=${customer.id}`;
                console.log('å‡†å¤‡è·³è½¬åˆ°:', targetUrl);
                window.location.href = targetUrl;
            } else {
                console.error('å®¢æˆ·IDç¼ºå¤±ï¼Œæ— æ³•è·³è½¬');
                console.error('å®¢æˆ·å¯¹è±¡è¯¦æƒ…:', JSON.stringify(customer, null, 2));
                alert('å®¢æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è·³è½¬åˆ°è¯¦æƒ…é¡µé¢\nå®¢æˆ·ID: ' + customer.id);
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoadingState() {
            hideInitialView();
            showSearchResults();
            
            const resultsHeader = document.querySelector('.results-header h3');
            resultsHeader.textContent = 'æœç´¢ä¸­...';
            
            resultList.innerHTML = `
                <div class="loading">
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 16px;">æ­£åœ¨æœç´¢å®¢æˆ·...</div>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showErrorMessage(message) {
            hideInitialView();
            showSearchResults();
            
            const resultsHeader = document.querySelector('.results-header h3');
            resultsHeader.textContent = 'æœç´¢å‡ºé”™';
            
            resultList.innerHTML = `
                <div class="error">
                    <div style="text-align: center; padding: 40px 20px; color: #e53e3e;">
                        <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                        <div style="font-size: 16px;">${escapeHtml(message)}</div>
                    </div>
                </div>
            `;
        }

        // æ¸…ç©ºæœç´¢
        function clearSearch() {
            searchInput.value = '';
            currentSearchTerm = '';
            showInitialView();
        }

        // æ˜¾ç¤ºåˆå§‹è§†å›¾
        function showInitialView() {
            searchHistory.style.display = 'block';
            filterSection.style.display = 'block';
            searchResults.classList.add('hidden');
        }

        // éšè—åˆå§‹è§†å›¾
        function hideInitialView() {
            searchHistory.style.display = 'none';
            // ä¸éšè—æ ‡ç­¾ç­›é€‰åŒºåŸŸï¼Œä¿æŒå¯è§
            // filterSection.style.display = 'none';
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function showSearchResults() {
            searchResults.classList.remove('hidden');
            // ä¿æŒæ ‡ç­¾ç­›é€‰åŒºåŸŸå¯è§
            filterSection.style.display = 'block';
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const testUrl = window.GlobalApiConfig.getUrl(window.GlobalApiConfig.ENDPOINTS.CUSTOMERS.SEARCH);
            
            console.log('æµ‹è¯•APIè¿æ¥:', testUrl);
            
            try {
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        search: 'test',
                        limit: 1,
                        page: 1,
                        timestamp: Date.now()
                    })
                });
                
                console.log('æµ‹è¯•å“åº”çŠ¶æ€:', response.status);
                console.log('æµ‹è¯•å“åº”å¤´:', Object.fromEntries(response.headers));
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('æµ‹è¯•å“åº”æ•°æ®:', data);
                    alert(`è¿æ¥æˆåŠŸ!\nçŠ¶æ€: ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    console.error('æµ‹è¯•å¤±è´¥:', errorText);
                    alert(`è¿æ¥å¤±è´¥!\nçŠ¶æ€: ${response.status}\né”™è¯¯: ${errorText}`);
                }
            } catch (error) {
                console.error('æµ‹è¯•é”™è¯¯:', error);
                alert(`è¿æ¥é”™è¯¯: ${error.message}`);
            }
        }
        
        // ==================== æ ‡ç­¾åŠŸèƒ½ ====================
        
        // åŠ è½½æ ‡ç­¾ç»´åº¦æ•°æ® - å¸¦é‡è¯•æœºåˆ¶
        async function loadTagDimensions() {
            const maxRetries = 3;
            const timeoutMs = 2000; // 2ç§’è¶…æ—¶
            
            showTagsLoading(true);
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`åŠ è½½æ ‡ç­¾ç»´åº¦ - ç¬¬${attempt}æ¬¡å°è¯•`);
                    
                    // åˆ›å»ºå¸¦è¶…æ—¶çš„fetchè¯·æ±‚
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    const response = await fetch(`${getApiBaseUrl()}/api/v1/tag-dimensions`, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const result = await response.json();
                        tagDimensionsData = result.data || [];
                        console.log(`æ ‡ç­¾åŠ è½½æˆåŠŸï¼Œå…±${tagDimensionsData.length}ä¸ªç»´åº¦`);
                        renderTagDimensions(tagDimensionsData);
                        showTagsLoading(false);
                        return; // æˆåŠŸåˆ™é€€å‡º
                    } else {
                        console.error(`åŠ è½½æ ‡ç­¾ç»´åº¦å¤±è´¥ - çŠ¶æ€ç : ${response.status}`);
                        if (attempt === maxRetries) {
                            showTagsError('åç«¯æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
                        }
                    }
                } catch (error) {
                    console.error(`åŠ è½½æ ‡ç­¾ç»´åº¦æ—¶å‡ºé”™ - ç¬¬${attempt}æ¬¡å°è¯•:`, error.message);
                    
                    if (error.name === 'AbortError') {
                        console.log(`è¯·æ±‚è¶…æ—¶ - ç¬¬${attempt}æ¬¡å°è¯•`);
                    }
                    
                    if (attempt === maxRetries) {
                        // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
                        if (error.name === 'AbortError') {
                            showTagsError('åç«¯æœåŠ¡å¼‚å¸¸ï¼Œè¯·æ±‚è¶…æ—¶');
                        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                            showTagsError('åç«¯æœåŠ¡å¼‚å¸¸ï¼Œç½‘ç»œè¿æ¥å¤±è´¥');
                        } else {
                            showTagsError('åç«¯æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
                        }
                    } else {
                        // ä¸æ˜¯æœ€åä¸€æ¬¡ï¼Œç­‰å¾…åé‡è¯•
                        await new Promise(resolve => setTimeout(resolve, 500 * attempt)); // é€’å¢å»¶è¿Ÿ
                    }
                }
            }
            
            showTagsLoading(false);
        }
        
        // æ˜¾ç¤º/éšè—æ ‡ç­¾åŠ è½½çŠ¶æ€
        function showTagsLoading(show) {
            const loadingElement = document.getElementById('tags-loading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }
        
        // æ˜¾ç¤ºæ ‡ç­¾é”™è¯¯ä¿¡æ¯
        function showTagsError(message) {
            const container = document.getElementById('tags-dimensions-container');
            if (container) {
                container.innerHTML = `
                    <div class="error-message">
                        <div style="margin-bottom: 10px;">âš ï¸ ${message}</div>
                        <button onclick="retryLoadTags()" style="
                            background: #165dff;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                        ">ç‚¹å‡»é‡è¯•</button>
                    </div>
                `;
            }
        }
        
        // é‡è¯•åŠ è½½æ ‡ç­¾
        async function retryLoadTags() {
            console.log('ç”¨æˆ·ç‚¹å‡»é‡è¯•åŠ è½½æ ‡ç­¾');
            await loadTagDimensions();
        }
        
        // æ¸²æŸ“æ ‡ç­¾ç»´åº¦
        function renderTagDimensions(dimensions) {
            const container = document.getElementById('tags-dimensions-container');
            if (!container) return;
            
            if (!dimensions || dimensions.length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— æ ‡ç­¾æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = '';
            
            dimensions.forEach(dimension => {
                const filterGroup = document.createElement('div');
                filterGroup.className = 'filter-group';
                
                const labelSpan = document.createElement('span');
                labelSpan.className = 'filter-label';
                labelSpan.textContent = dimension.name + 'ï¼š';
                filterGroup.appendChild(labelSpan);
                
                if (dimension.tags && dimension.tags.length > 0) {
                    dimension.tags.forEach(tag => {
                        const tagSpan = document.createElement('span');
                        tagSpan.className = 'tag';
                        tagSpan.textContent = tag.name;
                        tagSpan.dataset.tagId = tag.id;
                        tagSpan.onclick = () => toggleTagFilter(tagSpan, tag.id, tag.name);
                        filterGroup.appendChild(tagSpan);
                    });
                } else {
                    const emptySpan = document.createElement('span');
                    emptySpan.className = 'empty-tag';
                    emptySpan.textContent = 'æš‚æ— æ ‡ç­¾';
                    emptySpan.style.color = '#999';
                    filterGroup.appendChild(emptySpan);
                }
                
                container.appendChild(filterGroup);
            });
            
            // æ¢å¤æ ‡ç­¾é€‰æ‹©çŠ¶æ€
            updateTagSelectionDisplay();
        }
        
        // åˆ‡æ¢æ ‡ç­¾ç­›é€‰çŠ¶æ€
        function toggleTagFilter(tagElement, tagId, tagName) {
            const isSelected = tagElement.classList.contains('selected');
            
            if (isSelected) {
                // å–æ¶ˆé€‰æ‹©
                tagElement.classList.remove('selected');
                selectedTags.delete(tagId);
            } else {
                // é€‰æ‹©æ ‡ç­¾
                tagElement.classList.add('selected');
                selectedTags.add(tagId);
            }
            
            console.log('æ ‡ç­¾é€‰æ‹©çŠ¶æ€:', { tagId, tagName, selected: !isSelected });
            console.log('å½“å‰é€‰ä¸­æ ‡ç­¾:', Array.from(selectedTags));
            
            // æ›´æ–°æ ‡ç­¾é€‰æ‹©çŠ¶æ€çš„è§†è§‰æ˜¾ç¤º
            updateTagSelectionDisplay();
            
            // æ ¹æ®é€‰ä¸­çš„æ ‡ç­¾ç­›é€‰å®¢æˆ·
            if (selectedTags.size > 0) {
                searchByTags(Array.from(selectedTags));
            } else {
                // æ²¡æœ‰é€‰ä¸­æ ‡ç­¾æ—¶ï¼Œæ¸…ç©ºæœç´¢ç»“æœ
                showInitialView();
            }
        }
        
        // æ›´æ–°æ ‡ç­¾é€‰æ‹©çŠ¶æ€çš„è§†è§‰æ˜¾ç¤º
        function updateTagSelectionDisplay() {
            // ç¡®ä¿æ‰€æœ‰é€‰ä¸­çš„æ ‡ç­¾ä¿æŒé«˜äº®çŠ¶æ€
            const allTags = document.querySelectorAll('.tag[data-tag-id]');
            allTags.forEach(tagElement => {
                const tagId = parseInt(tagElement.dataset.tagId);
                if (selectedTags.has(tagId)) {
                    tagElement.classList.add('selected');
                } else {
                    tagElement.classList.remove('selected');
                }
            });
        }
        
        // æ ¹æ®æ ‡ç­¾æœç´¢å®¢æˆ·
        async function searchByTags(tagIds) {
            if (tagIds.length === 0) return;
            
            try {
                showLoadingState();
                
                const response = await fetch(`${getApiBaseUrl()}/api/v1/customers/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        search: '',
                        system_tags: tagIds,
                        limit: 50,
                        page: 1,
                        timestamp: Date.now()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`æœç´¢å¤±è´¥: ${response.status}`);
                }
                
                const result = await response.json();
                const customers = result.data?.customers || [];
                
                console.log('æ ‡ç­¾æœç´¢ç»“æœ:', customers.length, 'ä¸ªå®¢æˆ·');
                displaySearchResults(customers);
                
                // æœç´¢åæ¢å¤æ ‡ç­¾é€‰æ‹©çŠ¶æ€
                updateTagSelectionDisplay();
                
            } catch (error) {
                console.error('æ ‡ç­¾æœç´¢å¤±è´¥:', error);
                showErrorMessage('æ ¹æ®æ ‡ç­¾æœç´¢å®¢æˆ·å¤±è´¥');
            }
        }
    </script>
</body>
</html>