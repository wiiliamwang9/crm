<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索</title>
    <link rel="stylesheet" href="style.css">
    <!-- 引入全局API配置 -->
    <script src="../config/api-config.js"></script>
    <style>
        /* 文字头像样式 */
        .text-avatar {
            position: relative;
            width: 44px;
            height: 44px;
            background-color: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50%;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        
        .result-item .avatar {
            position: relative;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .result-item .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* 标签加载错误提示样式 */
        .error-message {
            text-align: center;
            padding: 20px;
            color: #ff4757;
            font-size: 14px;
            background-color: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部搜索区域 -->
        <header class="header">
            <div class="header-content">
                <button class="back-btn">‹</button>
                <button class="close-btn">×</button>
                <h1 class="title">搜索</h1>
                <button class="menu-btn">⋯</button>
            </div>
            
            <div class="search-section">
                <div class="search-input-wrapper">
                    <input type="text" class="search-input" placeholder="搜索客户、组织等">
                    <button class="cancel-btn">取消</button>
                </div>
                <!-- 环境状态显示 -->
                <div id="env-status" style="font-size: 12px; color: #666; text-align: center; margin-top: 5px; display: none;">
                    环境：<span id="current-env">--</span> | API：<span id="api-url">--</span>
                    <button onclick="testApiConnection()" style="margin-left: 10px; font-size: 10px; padding: 2px 6px;">测试连接</button>
                </div>
            </div>
        </header>

        <!-- 主要内容区域 -->
        <main class="main-content">
            <!-- 搜索历史 -->
            <section class="search-history">
                <div class="section-header">
                    <h2>搜索历史</h2>
                    <button class="clear-history">🗑</button>
                </div>
                <div class="history-tags">
                </div>
            </section>

            <!-- 标签筛选 -->
            <section class="filter-section">
                <h3>标签</h3>
                <div id="tags-loading" class="loading" style="display: none;">
                    <div>🔄 加载标签中...</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">首次加载可能较慢，请稍候</div>
                </div>
                <div id="tags-dimensions-container">
                    <!-- 标签将通过JavaScript动态加载 -->
                </div>
            </section>

            <!-- 搜索结果 -->
            <section class="search-results hidden">
                <div class="results-header">
                    <h3>客户 (0)</h3>
                </div>
                <div class="result-list">
                    <!-- 搜索结果将通过JavaScript动态生成 -->
                </div>
            </section>
        </main>

        <!-- 底部导航 -->
        <div class="view-15">
            <div class="frame-22">
                <img src="../statics/home.svg" class="img-3" width="22" height="22" />
                <div class="text-wrapper-23">首页</div>
            </div>
            <div class="frame-22">
                <img class="img-3" src="../statics/personal-collection.svg" width="22" height="22" />
                <div class="text-wrapper-24">客户</div>
            </div>
            <div class="frame-22">
                <img class="img-3" src="../statics/optional.svg" width="22" height="22" />
                <div class="text-wrapper-23">业绩</div>
            </div>
            <div class="frame-22">
                <img class="img-3" src="../statics/config.svg" width="22" height="22" />
                <div class="text-wrapper-23">设置</div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentSearchTerm = '';
        let isSearching = false;
        let searchCache = new Map(); // 搜索结果缓存
        let searchTimeout = null; // 防抖定时器
        let searchHistoryData = []; // 搜索历史记录
        let tagDimensionsData = []; // 标签维度数据
        let selectedTags = new Set(); // 已选择的标签
        
        // ==================== 环境配置 ====================
        // API配置现在从全局配置文件 ../config/api-config.js 中加载
        
        // 等待全局配置加载完成
        function waitForGlobalConfig() {
            return new Promise((resolve) => {
                if (window.GlobalApiConfig) {
                    resolve();
                } else {
                    setTimeout(() => waitForGlobalConfig().then(resolve), 100);
                }
            });
        }
        
        // 配置常量（保留非API相关的配置）
        const CONFIG = {
            REQUEST_TIMEOUT: 30000, // 30秒超时
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000, // 1秒重试延迟
            DEBOUNCE_DELAY: 500, // 500ms防抖延迟
            CACHE_EXPIRE_TIME: 5 * 60 * 1000, // 5分钟缓存过期
            MAX_SEARCH_HISTORY: 10, // 最大搜索历史数量
            SEARCH_HISTORY_KEY: 'crm_search_history' // 本地存储键名
        };

        // DOM元素
        const searchInput = document.querySelector('.search-input');
        const cancelBtn = document.querySelector('.cancel-btn');
        const searchHistory = document.querySelector('.search-history');
        const filterSection = document.querySelector('.filter-section');
        const searchResults = document.querySelector('.search-results');
        const resultList = document.querySelector('.result-list');

        // 获取API基础URL (使用全局配置)
        function getApiBaseUrl() {
            return window.GlobalApiConfig ? window.GlobalApiConfig.BASE_URL : '';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 等待全局配置加载完成
            await waitForGlobalConfig();
            
            initializeEventListeners();
            updateEnvDisplay();
            
            // 加载搜索历史
            loadSearchHistory();
            renderSearchHistory();
            
            // 加载标签数据
            await loadTagDimensions();
            
            console.log('=== 环境配置信息 ===');
            console.log('当前环境:', window.GlobalApiConfig.ENV_NAME);
            console.log('API基础URL:', window.GlobalApiConfig.BASE_URL);
            console.log('当前访问协议:', window.location.protocol);
            console.log('==================');
        });
        
        // 更新环境显示
        function updateEnvDisplay() {
            const envStatus = document.getElementById('env-status');
            const currentEnvSpan = document.getElementById('current-env');
            const apiUrlSpan = document.getElementById('api-url');
            
            if (envStatus && currentEnvSpan && apiUrlSpan) {
                currentEnvSpan.textContent = window.GlobalApiConfig.ENV_NAME;
                apiUrlSpan.textContent = window.GlobalApiConfig.BASE_URL;
                // 在开发时显示环境信息，生产环境可以隐藏
                if (window.GlobalApiConfig.ENV_NAME === 'LOCAL') {
                    envStatus.style.display = 'block';
                }
            }
        }

        function initializeEventListeners() {
            // 搜索输入事件 - 使用优化后的防抖
            searchInput.addEventListener('input', debounce(handleSearch, CONFIG.DEBOUNCE_DELAY));
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });

            // 取消按钮
            cancelBtn.addEventListener('click', clearSearch);

            // 清空搜索历史按钮
            const clearHistoryBtn = document.querySelector('.clear-history');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearSearchHistory);
            }

            // 返回按钮
            document.querySelector('.back-btn').addEventListener('click', function() {
                window.history.back();
            });

            // 关闭按钮
            document.querySelector('.close-btn').addEventListener('click', function() {
                window.close();
            });
        }

        // 防抖函数 - 优化版
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    searchTimeout = null;
                    func.apply(this, args);
                };
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                searchTimeout = setTimeout(later, wait);
            };
        }
        
        // 缓存管理
        function getCachedResult(key) {
            const cached = searchCache.get(key);
            if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_EXPIRE_TIME) {
                return cached.data;
            }
            return null;
        }
        
        function setCachedResult(key, data) {
            searchCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
            // 限制缓存大小
            if (searchCache.size > 50) {
                const firstKey = searchCache.keys().next().value;
                searchCache.delete(firstKey);
            }
        }
        
        // 超时控制的fetch
        async function fetchWithTimeout(url, options, timeout = CONFIG.REQUEST_TIMEOUT) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        // ==================== 搜索历史管理 ====================
        
        // 从本地存储加载搜索历史
        function loadSearchHistory() {
            try {
                const saved = localStorage.getItem(CONFIG.SEARCH_HISTORY_KEY);
                searchHistoryData = saved ? JSON.parse(saved) : [];
            } catch (error) {
                console.error('加载搜索历史失败:', error);
                searchHistoryData = [];
            }
        }

        // 保存搜索历史到本地存储
        function saveSearchHistory() {
            try {
                localStorage.setItem(CONFIG.SEARCH_HISTORY_KEY, JSON.stringify(searchHistoryData));
            } catch (error) {
                console.error('保存搜索历史失败:', error);
            }
        }

        // 添加搜索关键词到历史记录
        function addToSearchHistory(keyword) {
            if (!keyword || keyword.trim() === '') return;
            
            keyword = keyword.trim();
            
            // 如果已存在，先移除旧的
            const index = searchHistoryData.indexOf(keyword);
            if (index > -1) {
                searchHistoryData.splice(index, 1);
            }
            
            // 添加到最前面
            searchHistoryData.unshift(keyword);
            
            // 限制历史记录数量
            if (searchHistoryData.length > CONFIG.MAX_SEARCH_HISTORY) {
                searchHistoryData = searchHistoryData.slice(0, CONFIG.MAX_SEARCH_HISTORY);
            }
            
            // 保存到本地存储
            saveSearchHistory();
            
            // 更新界面
            renderSearchHistory();
        }

        // 渲染搜索历史界面
        function renderSearchHistory() {
            const historyTagsContainer = document.querySelector('.history-tags');
            if (!historyTagsContainer) return;
            
            // 清空现有内容
            historyTagsContainer.innerHTML = '';
            
            // 添加搜索历史标签
            searchHistoryData.forEach(keyword => {
                const tag = document.createElement('span');
                tag.className = 'history-tag';
                tag.textContent = keyword;
                tag.addEventListener('click', () => {
                    searchInput.value = keyword;
                    handleSearch();
                });
                historyTagsContainer.appendChild(tag);
            });
        }

        // 清空搜索历史
        function clearSearchHistory() {
            searchHistoryData = [];
            saveSearchHistory();
            renderSearchHistory();
        }
        
        // 重试机制
        async function retryRequest(requestFn, maxRetries = CONFIG.MAX_RETRIES) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await requestFn();
                } catch (error) {
                    lastError = error;
                    console.warn(`请求失败，第${attempt}次尝试:`, error.message);
                    
                    if (attempt < maxRetries) {
                        const delay = CONFIG.RETRY_DELAY * attempt; // 递增延迟
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw lastError;
        }

        // 处理搜索
        async function handleSearch() {
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm === '') {
                showInitialView();
                return;
            }

            if (searchTerm === currentSearchTerm && isSearching) {
                return; // 避免重复搜索
            }

            currentSearchTerm = searchTerm;
            isSearching = true;

            try {
                console.log('开始搜索:', searchTerm);
                showLoadingState();
                const customers = await searchCustomers(searchTerm);
                console.log('搜索结果:', customers);
                displaySearchResults(customers);
                
                // 搜索成功后添加到搜索历史
                addToSearchHistory(searchTerm);
            } catch (error) {
                console.error('搜索失败:', error);
                console.error('错误详情:', error.message, error.stack);
                showErrorMessage(`搜索失败: ${error.message || '请稍后重试'}`);
            } finally {
                isSearching = false;
            }
        }

        // 调用后端API搜索客户 - 使用POST请求、缓存、重试和超时
        async function searchCustomers(searchTerm) {
            // 检查缓存
            const cacheKey = searchTerm.toLowerCase().trim();
            const cached = getCachedResult(cacheKey);
            if (cached) {
                console.log('使用缓存结果:', searchTerm);
                return cached;
            }
            
            // 构建请求
            const apiUrl = window.GlobalApiConfig.getUrl(window.GlobalApiConfig.ENDPOINTS.CUSTOMERS.SEARCH);
            
            console.log('=== API 请求信息 ===');
            console.log('API URL:', apiUrl);
            console.log('搜索关键词:', searchTerm);
            console.log('==================');
            
            const requestBody = {
                search: searchTerm || ' ', // 确保搜索词不为空
                limit: 50,
                page: 1,
                timestamp: Date.now()
            };
            
            console.log('请求体:', JSON.stringify(requestBody, null, 2));
            
            // 使用重试机制进行请求
            const customers = await retryRequest(async () => {
                console.log('发送POST请求到:', apiUrl);
                console.log('请求方法: POST');
                console.log('请求头:', {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                });
                
                const response = await fetchWithTimeout(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('响应状态:', response.status, response.statusText);
                console.log('响应头:', Object.fromEntries(response.headers));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API错误响应:', errorText);
                    let errorMessage = `服务器错误 (${response.status})`;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        } else if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (parseError) {
                        console.log('无法解析错误响应为JSON:', parseError);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('API响应数据:', data);
                return data.data?.customers || data.customers || [];
            });
            
            // 缓存结果
            setCachedResult(cacheKey, customers);
            console.log('搜索完成，结果已缓存:', searchTerm, customers.length, '条记录');
            
            return customers;
        }

        // 显示搜索结果
        function displaySearchResults(customers) {
            hideInitialView();
            showSearchResults();

            // 更新结果数量
            const resultsHeader = document.querySelector('.results-header h3');
            resultsHeader.textContent = `客户 (${customers.length})`;

            // 清空现有结果
            resultList.innerHTML = '';

            if (customers.length === 0) {
                resultList.innerHTML = `
                    <div class="no-results">
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">未找到相关客户</div>
                            <div style="font-size: 14px;">请尝试其他关键词</div>
                        </div>
                    </div>
                `;
                return;
            }

            // 渲染客户列表
            customers.forEach(customer => {
                const resultItem = createCustomerResultItem(customer);
                resultList.appendChild(resultItem);
            });
        }

        // 创建客户结果项
        function createCustomerResultItem(customer) {
            console.log('创建客户结果项:', customer.name, 'ID:', customer.id);
            const div = document.createElement('div');
            div.className = 'result-item';
            div.setAttribute('data-customer-id', customer.id);

            // 处理标签
            const tags = createCustomerTags(customer);
            
            // 处理联系信息
            const contactInfo = getCustomerContactInfo(customer);

            // 处理头像
            const avatarHtml = createCustomerAvatarDisplay(customer);

            div.innerHTML = `
                ${avatarHtml}
                <div class="user-info">
                    <div class="user-name">${escapeHtml(customer.name || '未知客户')}</div>
                    <div class="user-detail">${escapeHtml(contactInfo)}</div>
                    <div class="user-tags">${tags}</div>
                </div>
            `;

            // 添加点击事件
            div.addEventListener('click', () => {
                handleCustomerClick(customer);
            });

            return div;
        }

        // 创建客户头像
        function createCustomerAvatarDisplay(customer) {
            console.log('创建客户头像:', customer.name, '头像URL:', customer.avatar);
            if (customer.avatar && customer.avatar.trim()) {
                // 有头像图片，显示图片
                console.log('使用图片头像');
                return `<div class="avatar"><img src="${escapeHtml(customer.avatar)}" alt="头像" /></div>`;
            } else if (customer.name) {
                // 没有头像图片，显示文字头像
                const firstChar = customer.name.charAt(0);
                console.log('使用文字头像:', firstChar);
                return `<div class="avatar"><div class="text-avatar">${escapeHtml(firstChar)}</div></div>`;
            } else {
                // 没有名称，使用默认
                console.log('使用默认头像');
                return `<div class="avatar"><div class="text-avatar">?</div></div>`;
            }
        }

        // 创建客户标签
        function createCustomerTags(customer) {
            const tags = [];

            // 客户等级标签
            if (customer.level) {
                const levelText = getLevelText(customer.level);
                if (levelText) {
                    tags.push(`<span class="tag-blue">${levelText}</span>`);
                }
            }

            // 客户状态标签
            if (customer.state) {
                const stateText = getStateText(customer.state);
                if (stateText) {
                    tags.push(`<span class="tag-green">${stateText}</span>`);
                }
            }

            // 自定义标签
            if (customer.tags && customer.tags.length > 0) {
                customer.tags.slice(0, 3).forEach(tag => {
                    tags.push(`<span class="tag-orange">${escapeHtml(tag)}</span>`);
                });
            }

            return tags.join('');
        }

        // 获取客户联系信息
        function getCustomerContactInfo(customer) {
            const info = [];
            
            if (customer.contact_name) {
                info.push(customer.contact_name);
            }
            
            if (customer.phone) {
                info.push(customer.phone);
            }
            
            if (customer.address) {
                info.push(customer.address);
            }

            return info.join(' • ') || '无联系信息';
        }

        // 获取等级文字
        function getLevelText(level) {
            const levelMap = {
                1: 'S级',
                2: 'A级', 
                3: 'B级',
                4: 'C级',
                10: 'X级'
            };
            return levelMap[level] || '';
        }

        // 获取状态文字
        function getStateText(state) {
            const stateMap = {
                1: '未开发',
                2: '开发中',
                3: '已开发',
                4: '已拉黑',
                5: '已倒闭',
                6: '同事',
                7: '叛徒',
                8: '同行'
            };
            return stateMap[state] || '';
        }

        // 处理客户点击
        function handleCustomerClick(customer) {
            console.log('=== 客户点击调试信息 ===');
            console.log('完整客户对象:', customer);
            console.log('客户ID:', customer.id);
            console.log('客户ID类型:', typeof customer.id);
            console.log('客户名称:', customer.name);
            console.log('========================');
            
            // 跳转到客户详情页面，传递客户ID作为参数
            if (customer.id) {
                const targetUrl = `../target/target.html?customer_id=${customer.id}`;
                console.log('准备跳转到:', targetUrl);
                window.location.href = targetUrl;
            } else {
                console.error('客户ID缺失，无法跳转');
                console.error('客户对象详情:', JSON.stringify(customer, null, 2));
                alert('客户信息不完整，无法跳转到详情页面\n客户ID: ' + customer.id);
            }
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 显示加载状态
        function showLoadingState() {
            hideInitialView();
            showSearchResults();
            
            const resultsHeader = document.querySelector('.results-header h3');
            resultsHeader.textContent = '搜索中...';
            
            resultList.innerHTML = `
                <div class="loading">
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 16px;">正在搜索客户...</div>
                    </div>
                </div>
            `;
        }

        // 显示错误信息
        function showErrorMessage(message) {
            hideInitialView();
            showSearchResults();
            
            const resultsHeader = document.querySelector('.results-header h3');
            resultsHeader.textContent = '搜索出错';
            
            resultList.innerHTML = `
                <div class="error">
                    <div style="text-align: center; padding: 40px 20px; color: #e53e3e;">
                        <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                        <div style="font-size: 16px;">${escapeHtml(message)}</div>
                    </div>
                </div>
            `;
        }

        // 清空搜索
        function clearSearch() {
            searchInput.value = '';
            currentSearchTerm = '';
            showInitialView();
        }

        // 显示初始视图
        function showInitialView() {
            searchHistory.style.display = 'block';
            filterSection.style.display = 'block';
            searchResults.classList.add('hidden');
        }

        // 隐藏初始视图
        function hideInitialView() {
            searchHistory.style.display = 'none';
            // 不隐藏标签筛选区域，保持可见
            // filterSection.style.display = 'none';
        }

        // 显示搜索结果
        function showSearchResults() {
            searchResults.classList.remove('hidden');
            // 保持标签筛选区域可见
            filterSection.style.display = 'block';
        }
        
        // 测试API连接
        async function testApiConnection() {
            const testUrl = window.GlobalApiConfig.getUrl(window.GlobalApiConfig.ENDPOINTS.CUSTOMERS.SEARCH);
            
            console.log('测试API连接:', testUrl);
            
            try {
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        search: 'test',
                        limit: 1,
                        page: 1,
                        timestamp: Date.now()
                    })
                });
                
                console.log('测试响应状态:', response.status);
                console.log('测试响应头:', Object.fromEntries(response.headers));
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('测试响应数据:', data);
                    alert(`连接成功!\n状态: ${response.status}\n响应: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    console.error('测试失败:', errorText);
                    alert(`连接失败!\n状态: ${response.status}\n错误: ${errorText}`);
                }
            } catch (error) {
                console.error('测试错误:', error);
                alert(`连接错误: ${error.message}`);
            }
        }
        
        // ==================== 标签功能 ====================
        
        // 加载标签维度数据 - 带重试机制
        async function loadTagDimensions() {
            const maxRetries = 3;
            const timeoutMs = 2000; // 2秒超时
            
            showTagsLoading(true);
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`加载标签维度 - 第${attempt}次尝试`);
                    
                    // 创建带超时的fetch请求
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    const response = await fetch(`${getApiBaseUrl()}/api/v1/tag-dimensions`, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const result = await response.json();
                        tagDimensionsData = result.data || [];
                        console.log(`标签加载成功，共${tagDimensionsData.length}个维度`);
                        renderTagDimensions(tagDimensionsData);
                        showTagsLoading(false);
                        return; // 成功则退出
                    } else {
                        console.error(`加载标签维度失败 - 状态码: ${response.status}`);
                        if (attempt === maxRetries) {
                            showTagsError('后端服务异常，请稍后重试');
                        }
                    }
                } catch (error) {
                    console.error(`加载标签维度时出错 - 第${attempt}次尝试:`, error.message);
                    
                    if (error.name === 'AbortError') {
                        console.log(`请求超时 - 第${attempt}次尝试`);
                    }
                    
                    if (attempt === maxRetries) {
                        // 最后一次尝试失败
                        if (error.name === 'AbortError') {
                            showTagsError('后端服务异常，请求超时');
                        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                            showTagsError('后端服务异常，网络连接失败');
                        } else {
                            showTagsError('后端服务异常，请稍后重试');
                        }
                    } else {
                        // 不是最后一次，等待后重试
                        await new Promise(resolve => setTimeout(resolve, 500 * attempt)); // 递增延迟
                    }
                }
            }
            
            showTagsLoading(false);
        }
        
        // 显示/隐藏标签加载状态
        function showTagsLoading(show) {
            const loadingElement = document.getElementById('tags-loading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }
        
        // 显示标签错误信息
        function showTagsError(message) {
            const container = document.getElementById('tags-dimensions-container');
            if (container) {
                container.innerHTML = `
                    <div class="error-message">
                        <div style="margin-bottom: 10px;">⚠️ ${message}</div>
                        <button onclick="retryLoadTags()" style="
                            background: #165dff;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                        ">点击重试</button>
                    </div>
                `;
            }
        }
        
        // 重试加载标签
        async function retryLoadTags() {
            console.log('用户点击重试加载标签');
            await loadTagDimensions();
        }
        
        // 渲染标签维度
        function renderTagDimensions(dimensions) {
            const container = document.getElementById('tags-dimensions-container');
            if (!container) return;
            
            if (!dimensions || dimensions.length === 0) {
                container.innerHTML = '<div class="no-data">暂无标签数据</div>';
                return;
            }
            
            container.innerHTML = '';
            
            dimensions.forEach(dimension => {
                const filterGroup = document.createElement('div');
                filterGroup.className = 'filter-group';
                
                const labelSpan = document.createElement('span');
                labelSpan.className = 'filter-label';
                labelSpan.textContent = dimension.name + '：';
                filterGroup.appendChild(labelSpan);
                
                if (dimension.tags && dimension.tags.length > 0) {
                    dimension.tags.forEach(tag => {
                        const tagSpan = document.createElement('span');
                        tagSpan.className = 'tag';
                        tagSpan.textContent = tag.name;
                        tagSpan.dataset.tagId = tag.id;
                        tagSpan.onclick = () => toggleTagFilter(tagSpan, tag.id, tag.name);
                        filterGroup.appendChild(tagSpan);
                    });
                } else {
                    const emptySpan = document.createElement('span');
                    emptySpan.className = 'empty-tag';
                    emptySpan.textContent = '暂无标签';
                    emptySpan.style.color = '#999';
                    filterGroup.appendChild(emptySpan);
                }
                
                container.appendChild(filterGroup);
            });
            
            // 恢复标签选择状态
            updateTagSelectionDisplay();
        }
        
        // 切换标签筛选状态
        function toggleTagFilter(tagElement, tagId, tagName) {
            const isSelected = tagElement.classList.contains('selected');
            
            if (isSelected) {
                // 取消选择
                tagElement.classList.remove('selected');
                selectedTags.delete(tagId);
            } else {
                // 选择标签
                tagElement.classList.add('selected');
                selectedTags.add(tagId);
            }
            
            console.log('标签选择状态:', { tagId, tagName, selected: !isSelected });
            console.log('当前选中标签:', Array.from(selectedTags));
            
            // 更新标签选择状态的视觉显示
            updateTagSelectionDisplay();
            
            // 根据选中的标签筛选客户
            if (selectedTags.size > 0) {
                searchByTags(Array.from(selectedTags));
            } else {
                // 没有选中标签时，清空搜索结果
                showInitialView();
            }
        }
        
        // 更新标签选择状态的视觉显示
        function updateTagSelectionDisplay() {
            // 确保所有选中的标签保持高亮状态
            const allTags = document.querySelectorAll('.tag[data-tag-id]');
            allTags.forEach(tagElement => {
                const tagId = parseInt(tagElement.dataset.tagId);
                if (selectedTags.has(tagId)) {
                    tagElement.classList.add('selected');
                } else {
                    tagElement.classList.remove('selected');
                }
            });
        }
        
        // 根据标签搜索客户
        async function searchByTags(tagIds) {
            if (tagIds.length === 0) return;
            
            try {
                showLoadingState();
                
                const response = await fetch(`${getApiBaseUrl()}/api/v1/customers/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        search: '',
                        system_tags: tagIds,
                        limit: 50,
                        page: 1,
                        timestamp: Date.now()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`搜索失败: ${response.status}`);
                }
                
                const result = await response.json();
                const customers = result.data?.customers || [];
                
                console.log('标签搜索结果:', customers.length, '个客户');
                displaySearchResults(customers);
                
                // 搜索后恢复标签选择状态
                updateTagSelectionDisplay();
                
            } catch (error) {
                console.error('标签搜索失败:', error);
                showErrorMessage('根据标签搜索客户失败');
            }
        }
    </script>
</body>
</html>